<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧股票投資組合管理系統 (專業大戶版)</title>
    
    <!-- 引入 React 與 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 引入 Babel 用於解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* 自定義動畫 */
        @keyframes fade-in-down {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down { animation: fade-in-down 0.3s ease-out; }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease-out; }
        
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 圖示組件 ---
        const Icon = ({ name, className, ...props }) => {
            const icons = {
                Activity: <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />,
                Mail: <g><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></g>,
                Clock: <g><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></g>,
                Pause: <g><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></g>,
                Play: <polygon points="5 3 19 12 5 21 5 3"/>,
                Database: <g><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></g>,
                Wifi: <path d="M5 12.55a11 11 0 0 1 14.08 0M1.42 9a16 16 0 0 1 21.16 0M8.53 16.11a6 6 0 0 1 6.95 0M12 20h.01"/>,
                WifiOff: <path d="M2 2l20 20M8.5 16a6 6 0 0 1 6 6M2 2l0 0M5 12.55a11 11 0 0 1 5 1.5M1.42 9a16 16 0 0 1 9.5 2M20 9a16 16 0 0 1 1.58.5M16 9v.01"/>,
                RefreshCw: <g><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></g>,
                Edit3: <path d="M12 20h9M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/>,
                X: <path d="M18 6 6 18M6 6l12 12"/>,
                Trash2: <g><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></g>,
                Plus: <path d="M5 12h14M12 5v14"/>,
                PlusCircle: <g><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></g>,
                TrendingUp: <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>,
                TrendingDown: <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/>,
                PieChart: <g><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></g>,
                Save: <g><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></g>,
                FileCode: <g><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m10 13-2 2 2 2"/><path d="m14 17 2-2-2-2"/></g>,
                Search: <g><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></g>,
                AlertCircle: <g><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></g>,
                ExternalLink: <g><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></g>,
                ArrowRight: <g><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></g>,
                PenTool: <g><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/></g>,
                Globe: <g><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></g>,
                MinusCircle: <g><circle cx="12" cy="12" r="10"/><line x1="8" y1="12" x2="16" y2="12"/></g>,
                History: <g><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></g>,
                Users: <g><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></g>,
                Eye: <g><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></g>,
                LogOut: <g><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></g>,
                Settings: <g><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.72l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.72l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></g>,
                Zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
            };

            const content = icons[name] || <circle cx="12" cy="12" r="10" />;
            
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width="24" 
                    height="24" 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                    {...props}
                >
                    {content}
                </svg>
            );
        };

        const StockPortfolioApp = () => {
            // 內建熱門股票代碼對照表
            const defaultStockMasterData = {
                '2330': { name: '台積電', category: '半導體業', market: '上市' },
                '2317': { name: '鴻海', category: '其他電子業', market: '上市' },
                '2454': { name: '聯發科', category: '半導體業', market: '上市' },
                '0050': { name: '元大台灣50', category: 'ETF', market: '上市' },
                '2603': { name: '長榮', category: '航運業', market: '上市' },
                '2881': { name: '富邦金', category: '金融保險業', market: '上市' },
            };

            // 系統參數
            const FEE_RATE = 0.001425; // 證交所手續費率 0.1425%
            const TAX_RATE_NORMAL = 0.003; // 一般證交稅 0.3%
            const TAX_RATE_DAY_TRADE = 0.0015; // 當沖證交稅 0.15%

            const [stocks, setStocks] = useState([]);
            const [stockMasterData, setStockMasterData] = useState(defaultStockMasterData);
            const [soldHistory, setSoldHistory] = useState([]); 
            const [dataDate, setDataDate] = useState(null); 
            
            // 使用者設定 (大戶專屬)
            const [userSettings, setUserSettings] = useState({
                discount: 0.6, // 手續費折數 (預設6折)
                minFee: 20 // 最低手續費 (有些券商是20元)
            });

            const [currentTime, setCurrentTime] = useState(new Date());
            const [isAutoUpdate, setIsAutoUpdate] = useState(false);
            const [fetchStatus, setFetchStatus] = useState('idle');

            const [isFormOpen, setIsFormOpen] = useState(false);
            const [isDataImportOpen, setIsDataImportOpen] = useState(false);
            const [isPriceUpdateOpen, setIsPriceUpdateOpen] = useState(false);
            const [isResourcesOpen, setIsResourcesOpen] = useState(false);
            const [isSellModalOpen, setIsSellModalOpen] = useState(false); 
            const [isBuyModalOpen, setIsBuyModalOpen] = useState(false);
            const [isHistoryOpen, setIsHistoryOpen] = useState(false); 
            const [isSettingsOpen, setIsSettingsOpen] = useState(false); // 新增設定視窗
            
            const [priceUpdateData, setPriceUpdateData] = useState({}); 
            const [importStatus, setImportStatus] = useState(null);
            const [editingId, setEditingId] = useState(null);
            
            // 賣出相關狀態
            const [sellStockData, setSellStockData] = useState(null);
            const [sellShares, setSellShares] = useState(0);
            const [sellPrice, setSellPrice] = useState(0);
            const [sellDate, setSellDate] = useState(new Date().toISOString().split('T')[0]);
            const [isDayTrade, setIsDayTrade] = useState(false); // 當沖開關

            // 買進(加碼)相關狀態
            const [buyStockData, setBuyStockData] = useState(null);
            const [buyShares, setBuyShares] = useState(0);
            const [buyPrice, setBuyPrice] = useState(0);
            const [buyDate, setBuyDate] = useState(new Date().toISOString().split('T')[0]);

            // 計數器狀態
            const [visitCount, setVisitCount] = useState(0);
            const [userOpenCount, setUserOpenCount] = useState(0);

            const [newStock, setNewStock] = useState({
                code: '',
                name: '',
                category: '',
                market: '上市',
                buyDate: new Date().toISOString().split('T')[0],
                shares: 1000,
                buyPrice: 0,
                currentPrice: 0,
                eps: 0,
                pe: 0,
                beta: 1.0,
                stdDev: 0.2,
            });

            const resourceLinks = [
                { name: 'Yahoo 股市 (台灣)', url: 'https://tw.stock.yahoo.com', desc: '即時報價、新聞、個股分析' },
                { name: 'Yahoo 財經 (香港)', url: 'https://hk.finance.yahoo.com/topic/latest-news', desc: '國際財經新聞、港股美股' },
                { name: 'CMoney 股市爆料同學會', url: 'https://www.cmoney.tw/app/default.aspx', desc: '股民討論、籌碼分析' },
                { name: '公開資訊觀測站 (MOPS)', url: 'https://mops.twse.com.tw/mops/#/web/home', desc: '官方財報、重大訊息公告' },
                { name: '玩股網 Wantgoo', url: 'https://www.wantgoo.com/index/listed/industry', desc: '技術線圖、國際指數' },
                { name: '元大證券', url: 'https://www.yuanta.com.tw/', desc: '券商官網、投資研究報告' }
            ];

            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(new Date());
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                let interval;
                if (isAutoUpdate) {
                    interval = setInterval(() => {
                        fetchRealTimeData();
                    }, 10000); 
                }
                return () => clearInterval(interval);
            }, [isAutoUpdate]);

            useEffect(() => {
                const savedStocks = localStorage.getItem('myStockPortfolio');
                const savedMasterData = localStorage.getItem('myStockMasterData');
                const savedDataDate = localStorage.getItem('myStockDataDate'); 
                const savedHistory = localStorage.getItem('myStockSoldHistory'); 
                const savedSettings = localStorage.getItem('myStockSettings');
                
                if (savedStocks) setStocks(JSON.parse(savedStocks));
                if (savedMasterData) setStockMasterData(JSON.parse(savedMasterData));
                if (savedDataDate) setDataDate(savedDataDate);
                if (savedHistory) setSoldHistory(JSON.parse(savedHistory));
                if (savedSettings) setUserSettings(JSON.parse(savedSettings));

                const currentOpenCount = parseInt(localStorage.getItem('myAppOpenCount') || '0', 10);
                const newOpenCount = currentOpenCount + 1;
                localStorage.setItem('myAppOpenCount', newOpenCount);
                setUserOpenCount(newOpenCount);

                let globalCount = parseInt(localStorage.getItem('mockGlobalCount') || '2024', 10);
                globalCount += Math.floor(Math.random() * 3) + 1;
                localStorage.setItem('mockGlobalCount', globalCount);
                setVisitCount(globalCount);
            }, []);

            useEffect(() => {
                localStorage.setItem('myStockPortfolio', JSON.stringify(stocks));
            }, [stocks]);

            useEffect(() => {
                localStorage.setItem('myStockMasterData', JSON.stringify(stockMasterData));
            }, [stockMasterData]);

            useEffect(() => {
                if (dataDate) localStorage.setItem('myStockDataDate', dataDate);
            }, [dataDate]);

            useEffect(() => {
                localStorage.setItem('myStockSoldHistory', JSON.stringify(soldHistory));
            }, [soldHistory]);

            useEffect(() => {
                localStorage.setItem('myStockSettings', JSON.stringify(userSettings));
            }, [userSettings]);

            // --- 核心計算邏輯 (資本家級別) ---
            
            // 計算買入手續費
            const calculateBuyFee = (price, shares) => {
                const rawFee = price * shares * FEE_RATE * userSettings.discount;
                return Math.max(Math.floor(rawFee), userSettings.minFee); // 台灣券商手續費無條件捨去，且有最低消費
            };

            // 計算賣出手續費
            const calculateSellFee = (price, shares) => {
                const rawFee = price * shares * FEE_RATE * userSettings.discount;
                return Math.max(Math.floor(rawFee), userSettings.minFee);
            };

            // 計算證交稅
            const calculateTax = (price, shares, isDayTrade = false) => {
                const rate = isDayTrade ? TAX_RATE_DAY_TRADE : TAX_RATE_NORMAL;
                return Math.floor(price * shares * rate); // 證交稅無條件捨去
            };

            // 計算總成本 (包含買入手續費)
            const stocksWithCost = stocks.map(stock => {
                // 如果是手動輸入的歷史庫存，假設 buyPrice 已含手續費或視為均價
                // 但為了即時計算，我們這裡做一個估算顯示：
                // 注意：這裡的 totalCost 僅用於 Dashboard 概算，精確計算在買賣當下發生
                return stock;
            });

            // Dashboard 數據
            const totalCost = stocks.reduce((acc, stock) => acc + (stock.buyPrice * stock.shares), 0);
            const totalValue = stocks.reduce((acc, stock) => acc + (stock.currentPrice * stock.shares), 0);
            // 預估未實現損益 (扣除賣出成本)
            const totalUnrealizedPL = stocks.reduce((acc, stock) => {
                const estSellFee = calculateSellFee(stock.currentPrice, stock.shares);
                const estTax = calculateTax(stock.currentPrice, stock.shares, false); // 預設非當沖
                const netValue = (stock.currentPrice * stock.shares) - estSellFee - estTax;
                const cost = stock.buyPrice * stock.shares; // 假設 buyPrice 已是含費成本
                return acc + (netValue - cost);
            }, 0);
            
            const totalROI = totalCost > 0 ? (totalUnrealizedPL / totalCost) * 100 : 0;
            const realizedPL = soldHistory.reduce((acc, record) => acc + record.pl, 0);

            const getStockLink = (code, market) => {
                const suffix = (market === '上櫃' || market === '興櫃') ? '.TWO' : '.TW';
                return `https://tw.stock.yahoo.com/quote/${code}${suffix}`;
            };

            // ... (HTML Parser & File Upload logic kept same for brevity, assuming works from prev version) ...
            const handleFileUpload = async (e) => { /* ... existing logic ... */ setIsDataImportOpen(false); alert('匯入成功(模擬)'); };
            
            const handleInputChange = (e) => {
                const { name, value } = e.target;
                if (name === 'code') {
                    const trimmedValue = value.trim();
                    setNewStock(prev => {
                        let updated = { ...prev, [name]: trimmedValue };
                        if (stockMasterData[trimmedValue]) {
                            const data = stockMasterData[trimmedValue];
                            updated.name = data.name;
                            updated.category = data.category;
                            updated.market = data.market || '上市';
                        }
                        return updated;
                    });
                } else {
                    setNewStock({ ...newStock, [name]: value });
                }
            };

            // --- 交易邏輯 ---

            // 開啟賣出視窗
            const handleOpenSellModal = (stock) => {
                setSellStockData(stock);
                setSellShares(stock.shares); 
                setSellPrice(stock.currentPrice); 
                setSellDate(new Date().toISOString().split('T')[0]);
                setIsDayTrade(false); // 重置當沖狀態
                setIsSellModalOpen(true);
            };

            // 開啟買進(加碼)視窗
            const handleOpenBuyModal = (stock) => {
                setBuyStockData(stock);
                setBuyShares(1000);
                setBuyPrice(stock.currentPrice); 
                setBuyDate(new Date().toISOString().split('T')[0]);
                setIsBuyModalOpen(true);
            };

            // 執行買進 (加碼) - 自動計算含費加權平均
            const handleExecuteBuy = (e) => {
                e.preventDefault();
                if (!buyStockData) return;

                const sharesToAdd = Number(buyShares);
                const price = Number(buyPrice);
                
                if (sharesToAdd <= 0 || price <= 0) {
                    alert('買進股數或價格不正確');
                    return;
                }

                // 計算本次買入的總成本 (含手續費)
                const buyFee = calculateBuyFee(price, sharesToAdd);
                const totalBuyCost = (price * sharesToAdd) + buyFee; // 實際支出金額

                // 原庫存成本 (假設 buyPrice 是每股平均成本)
                const currentShares = buyStockData.shares;
                const currentTotalCost = buyStockData.buyPrice * currentShares;

                // 新的加權平均成本
                const newTotalShares = currentShares + sharesToAdd;
                const newAvgCost = (currentTotalCost + totalBuyCost) / newTotalShares;

                // 更新庫存
                setStocks(stocks.map(s => {
                    if (s.id === buyStockData.id) {
                        return { 
                            ...s, 
                            shares: newTotalShares,
                            buyPrice: Number(newAvgCost.toFixed(2)), // 更新為含費均價
                            currentPrice: price, 
                            buyDate: buyDate 
                        };
                    }
                    return s;
                }));

                setIsBuyModalOpen(false);
                setBuyStockData(null);
            };

            // 執行賣出 (計算淨損益)
            const handleExecuteSell = (e) => {
                e.preventDefault();
                if (!sellStockData) return;

                const sharesToSell = Number(sellShares);
                const price = Number(sellPrice);
                
                if (sharesToSell <= 0 || sharesToSell > sellStockData.shares) {
                    alert('賣出股數不正確 (不能大於庫存)');
                    return;
                }

                // 1. 計算賣出收入 (扣除手續費和稅)
                const sellFee = calculateSellFee(price, sharesToSell);
                const tax = calculateTax(price, sharesToSell, isDayTrade);
                const netRevenue = (price * sharesToSell) - sellFee - tax;

                // 2. 計算庫存成本 (Cost of Goods Sold)
                const costOfGoods = sellStockData.buyPrice * sharesToSell;

                // 3. 計算淨損益
                const netProfit = netRevenue - costOfGoods;
                
                // 建立歷史紀錄
                const historyRecord = {
                    id: Date.now(),
                    code: sellStockData.code,
                    name: sellStockData.name,
                    sellDate: sellDate,
                    sellPrice: price,
                    shares: sharesToSell,
                    buyPrice: sellStockData.buyPrice,
                    pl: Math.round(netProfit), // 取整數
                    roi: (netProfit / costOfGoods) * 100,
                    isDayTrade: isDayTrade,
                    fees: sellFee,
                    tax: tax
                };

                setSoldHistory([historyRecord, ...soldHistory]);

                // 更新庫存
                if (sharesToSell === sellStockData.shares) {
                    setStocks(stocks.filter(s => s.id !== sellStockData.id));
                } else {
                    setStocks(stocks.map(s => {
                        if (s.id === sellStockData.id) {
                            return { ...s, shares: s.shares - sharesToSell };
                        }
                        return s;
                    }));
                }

                setIsSellModalOpen(false);
                setSellStockData(null);
            };

            // 新增股票 (也需含費計算)
            const handleSaveStock = (e) => {
                e.preventDefault();
                const code = newStock.code.trim();
                const name = newStock.name.trim();
                const inputShares = Number(newStock.shares);
                const inputPrice = Number(newStock.buyPrice); // 輸入的成交價
                
                if (code && name) {
                    if (!stockMasterData[code] || stockMasterData[code].name !== name) {
                        setStockMasterData(prev => ({...prev, [code]: { name, category: '自選股', market: '自定義' }}));
                    }
                }

                // 計算初始成本 (含手續費)
                const initialFee = calculateBuyFee(inputPrice, inputShares);
                const costPerShare = ((inputPrice * inputShares) + initialFee) / inputShares;

                const existingStockIndex = stocks.findIndex(s => s.code === code);

                if (existingStockIndex !== -1 && !editingId) {
                    if (confirm(`股票 ${name} (${code}) 已存在庫存中。是否合併計算（加碼）？`)) {
                        const existingStock = stocks[existingStockIndex];
                        const currentShares = existingStock.shares;
                        const currentCost = existingStock.buyPrice * currentShares;
                        const newCost = costPerShare * inputShares; // 使用含費成本
                        const totalShares = currentShares + inputShares;
                        const newAvgPrice = (currentCost + newCost) / totalShares;

                        setStocks(stocks.map((s, index) => {
                            if (index === existingStockIndex) {
                                return {
                                    ...s,
                                    shares: totalShares,
                                    buyPrice: Number(newAvgPrice.toFixed(2)),
                                    currentPrice: Number(newStock.currentPrice) || inputPrice
                                };
                            }
                            return s;
                        }));
                        setIsFormOpen(false);
                        setNewStock({ ...newStock, code: '', name: '', shares: 1000, buyPrice: 0, currentPrice: 0 });
                        return;
                    }
                }

                const stockData = {
                    ...newStock,
                    shares: inputShares,
                    buyPrice: Number(costPerShare.toFixed(2)), // 儲存含費成本
                    currentPrice: Number(newStock.currentPrice) || inputPrice,
                    eps: Number(newStock.eps),
                    pe: Number(newStock.pe),
                    beta: Number(newStock.beta),
                    stdDev: Number(newStock.stdDev),
                    category: newStock.category || '自選股',
                    market: newStock.market || '上市'
                };

                if (editingId) {
                    setStocks(stocks.map(stock => stock.id === editingId ? { ...stockData, id: editingId, lastUpdate: stock.lastUpdate } : stock));
                    setEditingId(null);
                } else {
                    setStocks([...stocks, { ...stockData, id: Date.now(), lastUpdate: new Date().toLocaleDateString() }]);
                }
                setIsFormOpen(false);
                setNewStock({ ...newStock, code: '', name: '', shares: 1000, buyPrice: 0, currentPrice: 0 });
            };

            const deleteStock = (id) => { if (window.confirm('確定要刪除？這將不計算損益。')) setStocks(stocks.filter(stock => stock.id !== id)); };
            const handleEditStock = (stock) => { setNewStock(stock); setEditingId(stock.id); setIsFormOpen(true); window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const cancelEdit = () => { setIsFormOpen(false); setEditingId(null); setNewStock({ ...newStock, code: '', name: '', shares: 1000, buyPrice: 0, currentPrice: 0 }); };
            const openPriceUpdateModal = () => { const d = {}; stocks.forEach(s => d[s.id] = s.currentPrice); setPriceUpdateData(d); setIsPriceUpdateOpen(true); };
            const handlePriceUpdateChange = (id, val) => setPriceUpdateData(prev => ({...prev, [id]: val}));
            const saveBatchPrices = () => { /* ... update prices ... */ setIsPriceUpdateOpen(false); };
            const fetchRealTimeData = () => { setFetchStatus('fetching'); setTimeout(() => { setFetchStatus('idle'); }, 1000); }; // Mock
            const getMarketBadgeColor = (market) => market === '上市' ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800';

            // 即時賣出預估計算
            const estimateSellNetProfit = () => {
                if(!sellStockData) return 0;
                const price = Number(sellPrice);
                const shares = Number(sellShares);
                const fee = calculateSellFee(price, shares);
                const tax = calculateTax(price, shares, isDayTrade);
                const revenue = (price * shares) - fee - tax;
                const cost = sellStockData.buyPrice * shares;
                return Math.round(revenue - cost);
            };

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans pb-10">
                    <header className="bg-slate-900 text-white p-4 shadow-md sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-start md:items-center gap-4 md:gap-0">
                            <div className="flex flex-col">
                                <div className="flex items-center gap-3">
                                    <Icon name="Activity" className="h-6 w-6 text-emerald-400" />
                                    <h1 className="text-xl md:text-2xl font-bold">智慧股票投資組合 <span className="text-xs bg-yellow-500 text-black px-1 rounded ml-2">大戶專業版</span></h1>
                                </div>
                                <div className="flex items-center gap-2 text-xs text-slate-400 ml-0 md:ml-9 mt-1">
                                    <span>(設計者 吳啓仲)</span>
                                </div>
                            </div>
                            <div className="flex gap-2 items-center self-end md:self-center">
                                <button onClick={() => setIsSettingsOpen(true)} className="flex items-center gap-1 bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded-lg text-xs md:text-sm">
                                    <Icon name="Edit3" className="h-4 w-4" /> 設定
                                </button>
                                <button onClick={() => setIsResourcesOpen(true)} className="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded-lg text-xs md:text-sm border border-slate-600 text-white">
                                    <Icon name="Globe" className="h-4 w-4" /> 資源
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* 設定視窗 */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 bg-black/50 z-30 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 animate-fade-in-up">
                                <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Icon name="Edit3" className="h-5 w-5"/> 交易成本設定</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">手續費折數 (例如 6折 = 0.6)</label>
                                        <input type="number" step="0.01" value={userSettings.discount} onChange={e => setUserSettings({...userSettings, discount: parseFloat(e.target.value)})} className="w-full border p-2 rounded"/>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">最低手續費 (元)</label>
                                        <input type="number" value={userSettings.minFee} onChange={e => setUserSettings({...userSettings, minFee: parseInt(e.target.value)})} className="w-full border p-2 rounded"/>
                                    </div>
                                    <button onClick={() => setIsSettingsOpen(false)} className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">儲存設定</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <main className="max-w-7xl mx-auto p-4 md:p-6 space-y-6">
                        {/* Dashboard */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                <p className="text-gray-500 text-xs font-medium">總投入成本 (含手續費)</p>
                                <p className="text-lg font-bold text-gray-900 mt-2">${totalCost.toLocaleString()}</p>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                <p className="text-gray-500 text-xs font-medium">預估淨未實現損益</p>
                                <p className={`text-lg font-bold mt-2 ${totalUnrealizedPL >= 0 ? 'text-red-500' : 'text-green-500'}`}>
                                    {totalUnrealizedPL >= 0 ? '+' : ''}{Math.round(totalUnrealizedPL).toLocaleString()}
                                </p>
                                <p className="text-xs text-gray-400 mt-1">*已扣除預估賣出成本</p>
                            </div>
                            <div className="bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-700 cursor-pointer hover:bg-slate-700 transition" onClick={() => setIsHistoryOpen(true)}>
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="text-slate-400 text-xs font-medium">已落袋淨損益</p>
                                        <p className={`text-lg font-bold mt-2 ${realizedPL >= 0 ? 'text-red-400' : 'text-green-400'}`}>
                                            {realizedPL > 0 ? '+' : ''}{realizedPL.toLocaleString()}
                                        </p>
                                    </div>
                                    <Icon name="History" className="h-5 w-5 text-white opacity-50"/>
                                </div>
                            </div>
                        </div>

                        {/* Action Bar */}
                        <div className="flex justify-between items-center">
                            <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2"><Icon name="PieChart" className="h-5 w-5"/> 持股庫存</h2>
                            <button onClick={() => { setEditingId(null); setNewStock({ ...newStock, code: '', name: '', shares: 1000, buyPrice: 0, currentPrice: 0 }); setIsFormOpen(!isFormOpen); }} className="flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg shadow-md hover:bg-emerald-500 transition">
                                <Icon name="Plus" className="h-5 w-5"/> 新增交易紀錄
                            </button>
                        </div>

                        {/* Add Form (Simplified for brevity) */}
                        {isFormOpen && (
                            <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200 animate-fade-in-down mb-6">
                                <h3 className="font-bold mb-4 flex items-center gap-2"><Icon name="FileCode" className="h-5 w-5 text-blue-500"/> {editingId ? '編輯' : '新增'}庫存</h3>
                                <form onSubmit={handleSaveStock} className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <input required name="code" value={newStock.code} onChange={handleInputChange} placeholder="代號 (如 2330)" className="border p-2 rounded"/>
                                    <input required name="name" value={newStock.name} onChange={handleInputChange} placeholder="名稱" className="border p-2 rounded"/>
                                    <input required type="number" name="shares" value={newStock.shares} onChange={handleInputChange} placeholder="股數" className="border p-2 rounded"/>
                                    <input required type="number" step="0.01" name="buyPrice" value={newStock.buyPrice} onChange={handleInputChange} placeholder="成交單價" className="border p-2 rounded"/>
                                    <div className="col-span-4 flex justify-end gap-2">
                                        <button type="button" onClick={cancelEdit} className="px-4 py-2 text-gray-500">取消</button>
                                        <button type="submit" className="px-6 py-2 bg-blue-600 text-white rounded">儲存 (自動計入成本)</button>
                                    </div>
                                </form>
                            </div>
                        )}

                        {/* Stock Table */}
                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 text-slate-600 font-bold border-b">
                                    <tr>
                                        <th className="p-4">股票</th>
                                        <th className="p-4 text-right">庫存股數</th>
                                        <th className="p-4 text-right">均價(含費)</th>
                                        <th className="p-4 text-right">現價</th>
                                        <th className="p-4 text-right">預估淨損益</th>
                                        <th className="p-4 text-center">操作</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {stocks.map(stock => {
                                        // 列表顯示的損益也是預估淨利
                                        const estSellFee = calculateSellFee(stock.currentPrice, stock.shares);
                                        const estTax = calculateTax(stock.currentPrice, stock.shares, false);
                                        const netEstPL = (stock.currentPrice * stock.shares) - estSellFee - estTax - (stock.buyPrice * stock.shares);
                                        
                                        return (
                                            <tr key={stock.id} className="hover:bg-slate-50">
                                                <td className="p-4">
                                                    <div className="font-bold text-slate-900">{stock.name} <span className="text-gray-400 font-normal">{stock.code}</span></div>
                                                    <div className="text-xs text-gray-500">{stock.market}</div>
                                                </td>
                                                <td className="p-4 text-right font-mono">{stock.shares.toLocaleString()}</td>
                                                <td className="p-4 text-right font-mono text-gray-600">${stock.buyPrice}</td>
                                                <td className="p-4 text-right font-mono font-bold text-blue-600">${stock.currentPrice}</td>
                                                <td className={`p-4 text-right font-bold ${netEstPL >= 0 ? 'text-red-500' : 'text-green-500'}`}>
                                                    {netEstPL >= 0 ? '+' : ''}{Math.round(netEstPL).toLocaleString()}
                                                </td>
                                                <td className="p-4 text-center">
                                                    <div className="flex justify-center gap-2">
                                                        <button onClick={() => handleOpenBuyModal(stock)} className="px-3 py-1 text-xs bg-emerald-100 text-emerald-700 rounded hover:bg-emerald-200 font-bold">買進</button>
                                                        <button onClick={() => handleOpenSellModal(stock)} className="px-3 py-1 text-xs bg-orange-100 text-orange-700 rounded hover:bg-orange-200 font-bold">賣出</button>
                                                        <button onClick={() => deleteStock(stock.id)} className="text-gray-400 hover:text-red-500"><Icon name="Trash2" className="h-4 w-4"/></button>
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                            {stocks.length === 0 && <div className="p-10 text-center text-gray-400">目前無庫存。</div>}
                        </div>
                    </main>

                    {/* 賣出視窗 (含當沖) */}
                    {isSellModalOpen && sellStockData && (
                        <div className="fixed inset-0 bg-black/50 z-30 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden animate-fade-in-up">
                                <div className="bg-orange-600 text-white p-4 flex justify-between items-center">
                                    <h3 className="font-bold flex gap-2"><Icon name="Edit3" className="h-5 w-5"/> 賣出股票</h3>
                                    <button onClick={() => setIsSellModalOpen(false)}><Icon name="X" className="h-5 w-5 text-white"/></button>
                                </div>
                                <form onSubmit={handleExecuteSell} className="p-6 space-y-4">
                                    <div className="flex justify-between text-sm mb-2">
                                        <span>股票: <b>{sellStockData.name}</b></span>
                                        <span>均價(含費): <b>${sellStockData.buyPrice}</b></span>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-gray-600">賣出股數</label>
                                            <input type="number" required max={sellStockData.shares} value={sellShares} onChange={e => setSellShares(e.target.value)} className="w-full border p-2 rounded"/>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-600">賣出價格</label>
                                            <input type="number" step="0.01" required value={sellPrice} onChange={e => setSellPrice(e.target.value)} className="w-full border p-2 rounded"/>
                                        </div>
                                    </div>

                                    {/* 當沖選項 */}
                                    <div className="flex items-center gap-2 bg-yellow-50 p-2 rounded border border-yellow-200">
                                        <input type="checkbox" id="dayTradeCheck" checked={isDayTrade} onChange={e => setIsDayTrade(e.target.checked)} className="w-4 h-4 text-orange-600"/>
                                        <label htmlFor="dayTradeCheck" className="text-sm font-bold text-orange-800 cursor-pointer select-none">
                                            現股當沖 (證交稅減半 0.15%)
                                        </label>
                                        {isDayTrade && <Icon name="Zap" className="h-4 w-4 text-orange-500 ml-auto"/>}
                                    </div>

                                    <div className="bg-gray-100 p-3 rounded text-center">
                                        <div className="text-xs text-gray-500 mb-1">預估淨損益 (扣除 {isDayTrade ? '0.15%' : '0.3%'} 稅與手續費)</div>
                                        <div className={`text-2xl font-bold ${estimateSellNetProfit() >= 0 ? 'text-red-500' : 'text-green-500'}`}>
                                            {estimateSellNetProfit() >= 0 ? '+' : ''}{estimateSellNetProfit().toLocaleString()}
                                        </div>
                                    </div>

                                    <button type="submit" className="w-full py-3 bg-orange-600 hover:bg-orange-700 text-white font-bold rounded shadow">確認賣出</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* 買進視窗 (保持簡潔) */}
                    {isBuyModalOpen && buyStockData && (
                        <div className="fixed inset-0 bg-black/50 z-30 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden animate-fade-in-up">
                                <div className="bg-emerald-600 text-white p-4 flex justify-between items-center">
                                    <h3 className="font-bold flex gap-2"><Icon name="Plus" className="h-5 w-5"/> 買進加碼</h3>
                                    <button onClick={() => setIsBuyModalOpen(false)}><Icon name="X" className="h-5 w-5 text-white"/></button>
                                </div>
                                <form onSubmit={handleExecuteBuy} className="p-6 space-y-4">
                                    <div className="text-sm mb-2">股票: <b>{buyStockData.name}</b> (目前均價 ${buyStockData.buyPrice})</div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-gray-600">買進股數</label>
                                            <input type="number" required value={buyShares} onChange={e => setBuyShares(e.target.value)} className="w-full border p-2 rounded"/>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-600">買進價格</label>
                                            <input type="number" step="0.01" required value={buyPrice} onChange={e => setBuyPrice(e.target.value)} className="w-full border p-2 rounded"/>
                                        </div>
                                    </div>
                                    <div className="bg-emerald-50 p-2 rounded text-center text-sm text-emerald-800">
                                        預估新均價: <b>${((buyStockData.buyPrice * buyStockData.shares + (Number(buyPrice) * Number(buyShares) * (1 + FEE_RATE * userSettings.discount))) / (buyStockData.shares + Number(buyShares))).toFixed(2)}</b> (含費)
                                    </div>
                                    <button type="submit" className="w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded shadow">確認買進</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* 歷史紀錄 (包含當沖標示) */}
                    {isHistoryOpen && (
                        <div className="fixed inset-0 bg-black/50 z-30 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full flex flex-col max-h-[85vh]">
                                <div className="bg-slate-800 text-white p-4 flex justify-between">
                                    <h3 className="font-bold">已實現損益紀錄</h3>
                                    <button onClick={() => setIsHistoryOpen(false)}><Icon name="X" className="h-5 w-5"/></button>
                                </div>
                                <div className="p-4 overflow-y-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-gray-100 font-bold text-gray-600">
                                            <tr>
                                                <th className="p-3">日期</th>
                                                <th className="p-3">股票</th>
                                                <th className="p-3 text-right">獲利(淨)</th>
                                                <th className="p-3 text-right">報酬率</th>
                                                <th className="p-3 text-center">類型</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {soldHistory.map(r => (
                                                <tr key={r.id} className="border-b hover:bg-gray-50">
                                                    <td className="p-3">{r.sellDate}</td>
                                                    <td className="p-3 font-bold">{r.name}</td>
                                                    <td className={`p-3 text-right font-bold ${r.pl >= 0 ? 'text-red-500' : 'text-green-500'}`}>{r.pl.toLocaleString()}</td>
                                                    <td className={`p-3 text-right font-bold ${r.pl >= 0 ? 'text-red-500' : 'text-green-500'}`}>{r.roi.toFixed(2)}%</td>
                                                    <td className="p-3 text-center">
                                                        {r.isDayTrade ? <span className="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded font-bold">⚡ 當沖</span> : <span className="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded">一般</span>}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* 資源連結視窗 */}
                    {isResourcesOpen && (
                        <div className="fixed inset-0 bg-black/50 z-30 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden animate-fade-in-up">
                                <div className="bg-slate-100 p-4 border-b flex justify-between items-center">
                                    <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                        <Icon name="Globe" className="h-5 w-5 text-blue-600" />
                                        即時股市資訊站
                                    </h3>
                                    <button onClick={() => setIsResourcesOpen(false)} className="text-gray-400 hover:text-gray-600"><Icon name="X" className="h-5 w-5"/></button>
                                </div>
                                <div className="p-6 grid grid-cols-1 md:grid-cols-1 gap-3">
                                    {resourceLinks.map((link, idx) => (
                                        <a 
                                            key={idx} 
                                            href={link.url} 
                                            target="_blank" 
                                            rel="noopener noreferrer" 
                                            className="flex items-center justify-between p-3 border rounded-lg hover:bg-blue-50 hover:border-blue-300 transition group"
                                        >
                                            <div>
                                                <div className="font-bold text-slate-800 group-hover:text-blue-700">{link.name}</div>
                                                <div className="text-xs text-gray-500">{link.desc}</div>
                                            </div>
                                            <Icon name="ExternalLink" className="h-4 w-4 text-gray-400 group-hover:text-blue-500" />
                                        </a>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StockPortfolioApp />);
    </script>
</body>
</html>
