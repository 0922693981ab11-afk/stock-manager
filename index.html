<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>智慧資產管家 (極致旗艦版)</title>
<script crossorigin="anonymous" src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin="anonymous" src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script crossorigin="anonymous" src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
.font-mono { font-family: 'Roboto Mono', monospace; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.anim-fade { animation: fadeIn 0.3s ease-out; }
.anim-slide { animation: slideUp 0.3s ease-out; }
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">
<div id="root" class="h-full flex flex-col"></div>
<script type="text/babel">
const { useState, useEffect, useMemo, useRef } = React;

// --- 錯誤防護網 ---
class ErrorBoundary extends React.Component {
    constructor(props) { super(props); this.state = { hasError: false, error: null }; }
    static getDerivedStateFromError(error) { return { hasError: true, error }; }
    componentDidCatch(error, errorInfo) { console.error("Error:", error, errorInfo); }
    render() {
        if (this.state.hasError) return (
            <div className="p-8 max-w-2xl mx-auto mt-10 bg-white rounded-xl shadow-lg border border-red-200">
                <h2 className="text-2xl font-bold text-red-600 mb-4">系統發生預期外的錯誤</h2>
                <p className="text-gray-600 mb-4">可能是暫存資料衝突或連線異常。請點擊下方按鈕重置系統。</p>
                <code className="block p-4 bg-gray-100 text-red-500 rounded text-sm mb-4 overflow-auto">{this.state.error?.toString()}</code>
                <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="bg-red-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-red-600">一鍵清除暫存並重新載入</button>
            </div>
        );
        return this.props.children;
    }
}

// --- LocalStorage Hook ---
const useLocalStorage = (key, fallbackKey, initialValue) => {
    const [storedValue, setStoredValue] = useState(() => {
        try {
            let item = window.localStorage.getItem(key) || window.localStorage.getItem(fallbackKey);
            if (item) {
                const parsed = JSON.parse(item);
                if (Array.isArray(initialValue) && !Array.isArray(parsed)) return initialValue;
                if (typeof initialValue === 'object' && initialValue !== null && (!parsed || typeof parsed !== 'object')) return initialValue;
                return parsed;
            }
            return initialValue;
        } catch (error) { return initialValue; }
    });
    useEffect(() => { try { window.localStorage.setItem(key, JSON.stringify(storedValue)); } catch (e) {} }, [key, storedValue]);
    return [storedValue, setStoredValue];
};

// --- 圖示 ---
const Icon = ({ name, size = 20, className = "" }) => {
    const icons = {
        activity: <g><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></g>,
        plus: <g><path d="M5 12h14M12 5v14" /></g>,
        minus: <g><path d="M5 12h14" /></g>,
        x: <g><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></g>,
        trash: <g><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></g>,
        refresh: <g><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></g>,
        settings: <g><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></g>,
        history: <g><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></g>,
        wallet: <g><rect width="20" height="14" x="2" y="5" rx="2" /><line x1="2" x2="22" y1="10" y2="10" /></g>,
        external: <g><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></g>,
        globe: <g><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></g>,
        download: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></g>,
        upload: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></g>,
        dollar: <g><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></g>,
        search: <g><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></g>,
        edit: <g><path d="M12 20h9M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></g>,
        wifi: <g><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><path d="M12 20h.01"/></g>,
        mail: <g><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></g>,
        database: <g><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></g>,
        chevrondown: <g><polyline points="6 9 12 15 18 9"/></g>,
        chevronup: <g><polyline points="18 15 12 9 6 15"/></g>
    };
    return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name.toLowerCase()] || <circle cx="12" cy="12" r="10"/>}</svg>;
};

// --- App ---
const App = () => {
    const defaultMaster = {'2330':{name:'台積電',market:'上市'},'2317':{name:'鴻海',market:'上市'},'0050':{name:'元大台灣50',market:'上市'}};
    const FEE_RATE = 0.001425; const TAX_RATE = 0.003; const TAX_RATE_DT = 0.0015;

    const [inventory, setInventory] = useLocalStorage('v4_inv', 'sp_inv', []);
    const [ledger, setLedger] = useLocalStorage('v4_ledger', 'sp_ledger', []);
    const [cash, setCash] = useLocalStorage('v4_cash', 'sp_cash', 1000000);
    const [settings, setSettings] = useLocalStorage('v4_settings', 'sp_settings', { discount: 0.6, minFee: 20 });
    const [masterData, setMasterData] = useLocalStorage('v4_master', 'sp_master', defaultMaster);

    const safeInv = Array.isArray(inventory) ? inventory : [];
    const safeLedger = Array.isArray(ledger) ? ledger : [];
    const safeCash = typeof cash === 'number' && !isNaN(cash) ? cash : 1000000;

    const [view, setView] = useState('inventory'); 
    const [modal, setModal] = useState({ isOpen: false, type: null, stock: null }); 
    const [sidePanel, setSidePanel] = useState(null); 
    const [currentTime, setCurrentTime] = useState(new Date());
    const [searchTerm, setSearchTerm] = useState('');
    const [isAutoUpdate, setIsAutoUpdate] = useState(false);
    const [fetchStatus, setFetchStatus] = useState('idle');
    const [expandedRows, setExpandedRows] = useState(new Set());
    const [formData, setFormData] = useState({ code:'', name:'', shares:'', price:'', date:'', isDayTrade:false, eps:'', pe:'', beta:'', stdDev:'' });

    useEffect(() => { const timer = setInterval(() => setCurrentTime(new Date()), 1000); return () => clearInterval(timer); }, []);

    const toggleRow = (code) => {
        const newSet = new Set(expandedRows);
        if (newSet.has(code)) newSet.delete(code); else newSet.add(code);
        setExpandedRows(newSet);
    };

    const fetchRealTimePrices = async (isManual = false) => {
        if (safeInv.length === 0) return isManual && alert('無庫存需更新。');
        setFetchStatus('fetching');
        try {
            const symbols = safeInv.map(s => `${s.code}${(s.market==='上櫃'||s.market==='興櫃')?'.TWO':'.TW'}`).join(',');
            const targetUrl = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbols}&_=${Date.now()}`;
            const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`);
            if (!res.ok) throw new Error('Network error');
            const data = await res.json();
            const quotes = JSON.parse(data.contents).quoteResponse?.result || [];
            const priceMap = {};
            quotes.forEach(q => priceMap[q.symbol.split('.')[0]] = q.regularMarketPrice);

            const timeStr = new Date().toLocaleTimeString();
            setInventory(prev => prev.map(s => priceMap[s.code] ? { ...s, currentPrice: priceMap[s.code], lastUpdate: timeStr+'(即時)' } : s));
            setFetchStatus('success');
            if (isManual) alert('已更新最新股價！');
        } catch (error) {
            setFetchStatus('error');
            if (isManual) alert('連線失敗。');
        } finally { setTimeout(() => setFetchStatus('idle'), 3000); }
    };

    useEffect(() => {
        let interval;
        if (isAutoUpdate) {
            fetchRealTimePrices();
            interval = setInterval(() => fetchRealTimePrices(), 10000);
        }
        return () => clearInterval(interval);
    }, [isAutoUpdate, safeInv.length]); 

    const { mktValue, totalCost, unrealizedPL, realizedPL, totalDiv } = useMemo(() => {
        const m = safeInv.reduce((a, s) => a + (s.currentPrice * s.shares), 0);
        const c = safeInv.reduce((a, s) => a + (s.avgCost * s.shares), 0);
        const rp = safeLedger.filter(r => r.type === '賣出').reduce((a, r) => a + (r.profit || 0), 0);
        const dv = safeLedger.filter(r => r.type === '股息').reduce((a, r) => a + r.amount, 0);
        return { mktValue: m, totalCost: c, unrealizedPL: m - c, realizedPL: rp, totalDiv: dv };
    }, [safeInv, safeLedger]);

    const totalAssets = safeCash + mktValue; // Added missing variable calculation

    const filteredInv = useMemo(() => {
        if (!searchTerm) return safeInv;
        return safeInv.filter(s => s.name.includes(searchTerm) || s.code.includes(searchTerm));
    }, [safeInv, searchTerm]);

    const calcFee = (amt) => Math.max(Math.floor(amt * FEE_RATE * settings.discount), settings.minFee);
    const calcTax = (amt, isDT) => Math.floor(amt * (isDT ? TAX_RATE_DT : TAX_RATE));

    const openModal = (type, stock = null) => {
        let data = { code:'', name:'', shares:'', price:'', date:new Date().toISOString().split('T')[0], isDayTrade:false, eps:'', pe:'', beta:'', stdDev:'' };
        if (stock) data = { ...data, code:stock.code, name:stock.name, price:stock.currentPrice, eps:stock.eps||'', pe:stock.pe||'', beta:stock.beta||'', stdDev:stock.stdDev||'' };
        if (['deposit','withdraw'].includes(type)) data.price = 1; 
        setFormData(data); setModal({ isOpen: true, type, stock });
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        const { code, name, date, isDayTrade, eps, pe, beta, stdDev } = formData;
        const shares = Number(formData.shares); const price = Number(formData.price);
        const type = modal.type;

        let newCash = safeCash; let newInv = [...safeInv]; let newLedger = [...safeLedger];

        if (type === 'edit') {
            const idx = newInv.findIndex(s => s.id === modal.stock?.id);
            if (idx >= 0) {
                newInv[idx] = { ...newInv[idx], name, eps: Number(eps)||0, pe: Number(pe)||0, beta: Number(beta)||0, stdDev: Number(stdDev)||0 };
                setInventory(newInv);
            }
            return setModal({ isOpen: false, type: null, stock: null });
        }

        if (shares <= 0 || price <= 0) return alert("數值錯誤");
        const totalAmt = shares * price;

        if (type === 'buy' || type === 'new') {
            const fee = calcFee(totalAmt); const cost = totalAmt + fee;
            if (!masterData[code]) setMasterData(p => ({...p, [code]:{name, market:'上市'}}));

            const idx = newInv.findIndex(s => s.code === code);
            if (idx >= 0) {
                const old = newInv[idx]; const totS = old.shares + shares;
                newInv[idx] = { ...old, shares: totS, avgCost: Number((((old.avgCost*old.shares)+cost)/totS).toFixed(2)), currentPrice: price, eps: Number(eps)||old.eps, pe: Number(pe)||old.pe };
            } else {
                newInv.push({ id: Date.now(), code, name, shares, avgCost: Number((cost/shares).toFixed(2)), currentPrice: price, eps: Number(eps)||0, pe: Number(pe)||0, market: masterData[code]?.market||'上市', lastUpdate: '手動輸入' });
            }
            newCash -= cost;
            newLedger.unshift({ id: Date.now(), date, type: '買進', name, code, shares, price, amount: -cost, balance: newCash, fee, tax: 0 });
        
        } else if (type === 'sell') {
            const fee = calcFee(totalAmt); const tax = calcTax(totalAmt, isDayTrade);
            const income = totalAmt - fee - tax;
            const idx = newInv.findIndex(s => s.code === code);
            
            if (idx < 0 || newInv[idx].shares < shares) return alert("庫存不足");
            const profit = Math.round(income - (newInv[idx].avgCost * shares));

            if (newInv[idx].shares === shares) newInv.splice(idx, 1);
            else newInv[idx] = { ...newInv[idx], shares: newInv[idx].shares - shares, currentPrice: price };
            
            newCash += income;
            newLedger.unshift({ id: Date.now(), date, type: '賣出', name, code, shares, price, amount: income, balance: newCash, profit, isDayTrade, fee, tax });
        } else if (type === 'dividend') {
            newCash += shares; newLedger.unshift({ id: Date.now(), date, type: '股息', name, code, shares: 0, price: 0, amount: shares, balance: newCash });
        } else if (type === 'deposit') {
            newCash += shares; newLedger.unshift({ id: Date.now(), date, type: '入金', name: '資金存入', code: '-', shares: 0, price: 0, amount: shares, balance: newCash });
        } else if (type === 'withdraw') {
            newCash -= shares; newLedger.unshift({ id: Date.now(), date, type: '出金', name: '資金取出', code: '-', shares: 0, price: 0, amount: -shares, balance: newCash });
        }

        setInventory(newInv); setLedger(newLedger); setCash(newCash);
        setModal({ isOpen: false, type: null, stock: null });
    };

    const parseHtmlContent = (content, fileName) => {
        try {
            const parser = new DOMParser();
            const doc = parser.parseFromString(content, 'text/html');
            const table = doc.querySelector('table.h4');
            if (!table) return { count: 0, data: {} };
            const rows = table.querySelectorAll('tr');
            let count = 0;
            const newData = {};
            rows.forEach((row, index) => {
                if (index === 0) return;
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    const rawCodeName = cells[0].textContent.trim();
                    const market = cells[3]?.textContent.trim();
                    const parts = rawCodeName.split(/[\s\u3000]+/); 
                    if (parts.length >= 2) {
                        const code = parts[0].trim();
                        const name = parts[1].trim();
                        if (code && !isNaN(parseInt(code[0]))) {
                            newData[code] = { name, market: market || '上市' };
                            count++;
                        }
                    }
                }
            });
            return { count, data: newData };
        } catch (error) { return { count: 0, data: {} }; }
    };

    const handleFileUpload = (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        let totalNew = 0;
        const mergedData = { ...(masterData || {}) };
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const result = parseHtmlContent(evt.target.result, file.name);
                if(result.count > 0) {
                    Object.assign(mergedData, result.data);
                    totalNew += result.count;
                }
                setMasterData({...mergedData});
                alert(`成功解析並匯入 ${totalNew} 筆資料。`);
            };
            reader.readAsText(file);
        });
        setSidePanel(null);
    };

    const getStockLink = (code, market) => `https://tw.stock.yahoo.com/quote/${code}${(market==='上櫃'||market==='興櫃')?'.TWO':'.TW'}`;

    return (
        <div className="flex flex-col h-screen max-w-6xl mx-auto w-full bg-slate-50 md:shadow-2xl relative">
            <header className="bg-slate-900 text-white px-4 py-3 flex justify-between items-center shrink-0 z-30 shadow-md">
                <div className="flex items-center gap-3">
                    <div className="bg-emerald-500 p-2 rounded-lg"><Icon name="activity" className="text-white"/></div>
                    <div>
                        <h1 className="font-bold text-lg leading-tight flex items-center">智慧資產管家 <span className="text-[10px] bg-yellow-500 text-slate-900 px-1.5 py-0.5 rounded ml-2 font-extrabold hidden md:inline">旗艦完整版</span></h1>
                        <div className="text-[10px] text-slate-400 font-mono mt-0.5 flex items-center gap-2"><span>(設計者 吳啓仲)</span></div>
                    </div>
                </div>
                <div className="flex gap-3 items-center">
                    <div className="hidden md:block text-emerald-400 font-mono font-bold text-sm mr-2">{currentTime.toLocaleTimeString()}</div>
                    <button onClick={() => setSidePanel('resources')} className="text-slate-300 hover:text-white"><Icon name="globe"/></button>
                    <button onClick={() => setSidePanel('settings')} className="text-slate-300 hover:text-white"><Icon name="settings"/></button>
                </div>
            </header>

            <div className="bg-white p-4 shadow-sm z-20 shrink-0 border-b border-gray-200">
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div className="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl p-4 text-white relative overflow-hidden group col-span-2 md:col-span-1">
                        <div className="absolute top-0 right-0 p-2 opacity-10"><Icon name="wallet" size={48}/></div>
                        <div className="text-blue-200 text-xs mb-1">總資產 (NAV)</div>
                        <div className="text-2xl font-bold mb-2">${Math.floor(totalAssets).toLocaleString()}</div>
                        <div className="border-t border-white/20 pt-2 flex justify-between items-end relative z-10">
                            <div><div className="text-blue-200 text-[10px]">可用現金</div><div className="font-mono font-bold">${Math.floor(safeCash).toLocaleString()}</div></div>
                            <div className="flex gap-1"><button onClick={()=>openModal('deposit')} className="bg-white/20 p-1 rounded"><Icon name="plus" size={14}/></button><button onClick={()=>openModal('withdraw')} className="bg-white/20 p-1 rounded"><Icon name="minus" size={14}/></button></div>
                        </div>
                    </div>
                    <div className="bg-white border rounded-xl p-3 flex flex-col justify-center">
                        <div className="text-gray-500 text-xs mb-1">股票總市值 / 總成本</div>
                        <div className="text-xl font-bold text-slate-800">${Math.floor(mktValue).toLocaleString()}</div>
                        <div className="text-xs text-gray-400 mt-1 font-mono">成本 ${Math.floor(totalCost).toLocaleString()}</div>
                    </div>
                    <div className="bg-white border rounded-xl p-3 flex flex-col justify-center">
                        <div className="text-gray-500 text-xs mb-1">未實現損益 (帳面)</div>
                        <div className={`text-xl font-bold ${unrealizedPL >= 0 ? 'text-red-500' : 'text-green-500'}`}>{unrealizedPL >= 0 ? '+' : ''}{Math.floor(unrealizedPL).toLocaleString()}</div>
                        <div className={`text-xs mt-1 font-bold ${unrealizedPL >= 0 ? 'text-red-400' : 'text-green-400'}`}>報酬率 {totalCost > 0 ? (unrealizedPL / totalCost * 100).toFixed(2) : 0}%</div>
                    </div>
                    <div className="bg-slate-800 p-3 rounded-xl cursor-pointer hover:bg-slate-700 flex flex-col justify-center relative overflow-hidden" onClick={() => setView('ledger')}>
                        <div className="absolute right-0 bottom-0 opacity-10"><Icon name="history" size={60}/></div>
                        <div className="text-slate-400 text-xs mb-1 z-10">已實現損益 (落袋)</div>
                        <div className={`text-xl font-bold z-10 ${realizedPL + totalDiv >= 0 ? 'text-red-400' : 'text-green-400'}`}>{(realizedPL + totalDiv) >= 0 ? '+' : ''}{Math.floor(realizedPL + totalDiv).toLocaleString()}</div>
                        <div className="text-xs text-gray-400 mt-1 flex gap-2 z-10"><span>價差: {realizedPL.toLocaleString()}</span><span>股息: {totalDiv.toLocaleString()}</span></div>
                    </div>
                </div>

                <div className="mt-4 flex flex-wrap gap-2">
                    <button onClick={() => openModal('new')} className="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2"><Icon name="plus" size={16}/> 建立新倉位</button>
                    <button onClick={() => fetchRealTimePrices(true)} disabled={fetchStatus==='fetching'} className="border text-blue-600 px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2">{fetchStatus==='fetching'?<Icon name="wifi" size={16} className="animate-ping"/>:<Icon name="refresh" size={16}/>} 即時抓價</button>
                    <button onClick={() => setIsAutoUpdate(!isAutoUpdate)} className={`border px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-1 ${isAutoUpdate ? 'bg-red-50 text-red-600' : 'bg-gray-50'}`}>{isAutoUpdate ? <Icon name="x" size={14}/> : <Icon name="refresh" size={14}/>} {isAutoUpdate ? '關閉自動' : '自動更新'}</button>
                </div>
            </div>

            <div className="flex border-b bg-white z-10">
                <button onClick={() => setView('inventory')} className={`flex-1 py-3 text-sm font-bold border-b-2 ${view==='inventory'?'border-emerald-600 text-emerald-700':'border-transparent text-gray-500'}`}>庫存 ({safeInv.length})</button>
                <button onClick={() => setView('ledger')} className={`flex-1 py-3 text-sm font-bold border-b-2 ${view==='ledger'?'border-emerald-600 text-emerald-700':'border-transparent text-gray-500'}`}>帳本 ({safeLedger.length})</button>
                {view==='inventory' && <div className="p-2"><input value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} placeholder="搜尋..." className="bg-gray-100 rounded-full px-3 py-1.5 text-sm w-32 outline-none"/></div>}
            </div>

            <div className="flex-1 overflow-y-auto bg-gray-50 p-4">
                {view === 'inventory' && safeInv.length === 0 && (
                    <div className="text-center py-20 text-gray-400">無股票資料</div>
                )}
                {view === 'inventory' && safeInv.length > 0 && (
                    <div className="anim-fade pb-20">
                        <div className="bg-white rounded-xl shadow-sm border overflow-x-auto">
                            <table className="w-full text-sm text-left whitespace-nowrap">
                                <thead className="bg-slate-50 text-slate-600 border-b">
                                    <tr><th className="p-4">標的</th><th className="p-4 text-right">股數</th><th className="p-4 text-right text-indigo-700">均價(加權)</th><th className="p-4 text-right text-blue-700">市價</th><th className="p-4 text-right">市值/損益</th><th className="p-4 text-center">操作</th></tr>
                                </thead>
                                <tbody className="divide-y">
                                    {filteredInv.map(s => {
                                        const val = s.shares * s.currentPrice; const cost = s.shares * s.avgCost; const pl = val - cost; const roi = cost>0?(pl/cost)*100:0;
                                        const isExp = expandedRows.has(s.code);
                                        return (
                                            <React.Fragment key={s.id}>
                                                <tr className={`hover:bg-slate-50 cursor-pointer ${isExp?'bg-blue-50/30':''}`} onClick={()=>toggleRow(s.code)}>
                                                    <td className="p-4 pl-6">
                                                        <div className="flex items-center gap-2"><Icon name={isExp?'chevronup':'chevrondown'} size={16} className="text-gray-400"/><span className="font-bold text-base">{s.name}</span><span className="text-xs bg-gray-100 px-1.5 rounded">{s.code}</span></div>
                                                        <div className="text-[10px] text-gray-400 ml-6 mt-1">更新: {s.lastUpdate || '-'}</div>
                                                    </td>
                                                    <td className="p-4 text-right font-mono font-medium">{s.shares.toLocaleString()}</td>
                                                    <td className="p-4 text-right font-mono font-bold text-indigo-700 bg-indigo-50/30">${s.avgCost.toLocaleString()}</td>
                                                    <td className="p-4 text-right font-mono font-bold text-blue-600">
                                                        <div className={`transition-opacity duration-300 ${fetchStatus==='fetching' ? 'opacity-50' : 'opacity-100'}`}>
                                                            ${s.currentPrice}
                                                        </div>
                                                    </td>
                                                    <td className="p-4 text-right"><div className="font-mono">${Math.floor(val).toLocaleString()}</div><div className={`text-xs font-bold ${pl>=0?'text-red-500':'text-green-500'}`}>{pl>=0?'+':''}{Math.floor(pl).toLocaleString()} ({roi.toFixed(2)}%)</div></td>
                                                    <td className="p-4 text-center" onClick={e=>e.stopPropagation()}>
                                                        <div className="flex justify-center gap-2">
                                                            <button onClick={()=>openModal('buy',s)} className="p-2 bg-emerald-50 text-emerald-600 rounded-full hover:bg-emerald-100"><Icon name="plus" size={16}/></button>
                                                            <button onClick={()=>openModal('sell',s)} className="p-2 bg-orange-50 text-orange-600 rounded-full hover:bg-orange-100"><Icon name="minus" size={16}/></button>
                                                            <button onClick={()=>openModal('dividend',s)} className="p-2 bg-blue-50 text-blue-600 rounded-full hover:bg-blue-100"><Icon name="dollar" size={16}/></button>
                                                            <button onClick={()=>removeStock(s.id)} className="p-2 text-slate-300 hover:text-red-500"><Icon name="trash" size={16}/></button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {isExp && (
                                                    <tr className="bg-slate-100/50 anim-fade">
                                                        <td colSpan="6" className="p-4 pl-12">
                                                            <div className="text-xs font-bold text-gray-500 mb-2">歷史批次明細</div>
                                                            <div className="bg-white rounded border shadow-sm"><table className="w-full text-xs"><thead className="bg-gray-50"><tr><th className="p-2 pl-4">日期</th><th className="p-2">動作</th><th className="p-2 text-right">單價</th><th className="p-2 text-right">股數</th><th className="p-2 text-right">稅費</th><th className="p-2 text-right">總額</th></tr></thead><tbody>
                                                                {safeLedger.filter(l=>l.code===s.code&&(l.type==='買進'||l.type==='賣出')).map(l=>(
                                                                    <tr key={l.id} className="border-t"><td className="p-2 pl-4 text-gray-500">{l.date}</td><td className="p-2 font-bold">{l.type}</td><td className="p-2 text-right font-mono">${l.price}</td><td className="p-2 text-right font-mono">{l.shares}</td><td className="p-2 text-right font-mono">${(l.fee||0)+(l.tax||0)}</td><td className={`p-2 text-right font-bold font-mono ${l.type==='買進'?'':'text-green-600'}`}>{l.type==='買進'?'-':'+'}{Math.abs(l.amount).toLocaleString()}</td></tr>
                                                                ))}
                                                            </tbody></table></div>
                                                        </td>
                                                    </tr>
                                                )}
                                            </React.Fragment>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}

                {view === 'ledger' && safeLedger.length === 0 && (
                    <div className="text-center py-10 text-gray-400">尚無紀錄</div>
                )}
                {view === 'ledger' && safeLedger.length > 0 && (
                    <div className="space-y-2 pb-20 anim-fade p-4">
                        {safeLedger.map(r => (
                            <div key={r.id} className="bg-white p-3 rounded-lg border flex justify-between items-center hover:shadow transition">
                                <div className="flex items-center gap-3">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-xs shrink-0 ${
                                        r.type === '買進' ? 'bg-emerald-500' : r.type === '賣出' ? 'bg-orange-500' : r.type === '股息' ? 'bg-blue-500' : 'bg-slate-600'
                                    }`}>
                                        {r.type.substring(0, 2)}
                                    </div>
                                    <div>
                                        <div className="font-bold text-sm">
                                            {r.name} <span className="text-xs font-normal text-gray-400">{r.code !== '-' ? r.code : ''}</span>
                                            {r.isDayTrade && <span className="ml-2 text-[10px] bg-yellow-100 text-yellow-800 px-1 py-0.5 rounded border border-yellow-200">當沖</span>}
                                        </div>
                                        <div className="text-xs text-gray-400 mt-0.5">{r.date} {r.note && `• ${r.note}`}</div>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <div className={`font-mono font-bold text-sm ${r.amount >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                                        {r.amount > 0 ? '+' : ''}{r.amount.toLocaleString()}
                                    </div>
                                    <div className="text-[10px] text-gray-400">餘額 {Math.floor(r.balance).toLocaleString()}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>

            {modal.isOpen && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 p-4 anim-fade">
                    <div className="bg-white w-full max-w-md rounded-2xl overflow-hidden shadow-2xl anim-slide">
                        <div className={`p-4 text-white flex justify-between ${modal.type==='sell'?'bg-orange-500':modal.type==='dividend'?'bg-blue-600':['deposit','withdraw'].includes(modal.type)?'bg-slate-700':'bg-emerald-600'}`}>
                            <h3 className="font-bold text-lg">{modal.type==='new'?'建立新倉位':modal.type==='buy'?'加碼買進':modal.type==='sell'?'減碼賣出':modal.type==='dividend'?'股息入帳':'資金操作'}</h3>
                            <button onClick={()=>setModal({isOpen:false})}><Icon name="x"/></button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            {['new','buy','sell','dividend'].includes(modal.type) && (
                                <div className="flex gap-3">
                                    <div className="w-1/3"><label className="text-xs text-gray-500">代號</label><input value={formData.code} onChange={e=>setFormData({...formData,code:e.target.value,name:masterData[e.target.value]?.name||formData.name})} readOnly={modal.type!=='new'} className="w-full border p-2 rounded"/></div>
                                    <div className="w-2/3"><label className="text-xs text-gray-500">名稱</label><input value={formData.name} onChange={e=>setFormData({...formData,name:e.target.value})} readOnly={modal.type!=='new'} className="w-full border p-2 rounded"/></div>
                                </div>
                            )}
                            {['new','buy','sell'].includes(modal.type) && (
                                <div className="flex gap-3">
                                    <div className="w-1/2"><label className="text-xs text-gray-500">股數</label><input type="number" required max={modal.type==='sell'?modal.stock?.shares:undefined} value={formData.shares} onChange={e=>setFormData({...formData,shares:e.target.value})} className="w-full border p-2 rounded"/></div>
                                    <div className="w-1/2"><label className="text-xs text-gray-500">單價</label><input type="number" step="0.01" required value={formData.price} onChange={e=>setFormData({...formData,price:e.target.value})} className="w-full border p-2 rounded"/></div>
                                </div>
                            )}
                            {['dividend','deposit','withdraw'].includes(modal.type) && (
                                <div><label className="text-xs text-gray-500">總金額</label><input type="number" required value={formData.shares} onChange={e=>setFormData({...formData,shares:e.target.value})} className="w-full border p-2 rounded text-lg"/></div>
                            )}
                            {modal.type==='sell' && <div><label className="flex items-center gap-2"><input type="checkbox" checked={formData.isDayTrade} onChange={e=>setFormData({...formData,isDayTrade:e.target.checked})}/> 當沖 (稅率 0.15%)</label></div>}
                            <button type="submit" className="w-full py-3 bg-slate-800 text-white rounded-lg font-bold">確認</button>
                        </form>
                    </div>
                </div>
            )}

            {sidePanel && (
                <div className="fixed inset-0 z-50 flex justify-end bg-black/40" onClick={() => setSidePanel(null)}>
                    <div className="bg-white w-full max-w-sm h-full p-6 anim-slide" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6"><h3 className="font-bold text-xl">{sidePanel==='settings'?'系統設定':'常用資源'}</h3><button onClick={() => setSidePanel(null)}><Icon name="x"/></button></div>
                        {sidePanel === 'settings' && (
                            <div className="space-y-6">
                                <div><label className="text-xs text-gray-500">手續費折數 (0.6 = 6折)</label><input type="number" step="0.01" value={settings.discount} onChange={e=>setSettings({...settings, discount:Number(e.target.value)})} className="w-full border p-2 rounded bg-gray-50"/></div>
                                <div><label className="text-xs text-gray-500">最低手續費 (元)</label><input type="number" value={settings.minFee} onChange={e=>setSettings({...settings, minFee:Number(e.target.value)})} className="w-full border p-2 rounded bg-gray-50"/></div>
                                <button onClick={exportData} className="w-full py-2 border rounded font-bold">下載備份檔</button>
                                <button onClick={()=>{if(confirm("確定清空所有資料？")){localStorage.clear();window.location.reload();}}} className="w-full py-2 bg-red-50 text-red-600 rounded font-bold mt-4">清空系統</button>
                            </div>
                        )}
                        {sidePanel === 'resources' && (
                            <div className="space-y-3">
                                <a href="https://tw.stock.yahoo.com" target="_blank" className="block p-4 bg-gray-50 rounded font-bold border">Yahoo! 股市</a>
                                <a href="https://goodinfo.tw/tw/index.asp" target="_blank" className="block p-4 bg-gray-50 rounded font-bold border">Goodinfo! 台灣股市</a>
                                <a href="https://mops.twse.com.tw" target="_blank" className="block p-4 bg-gray-50 rounded font-bold border">公開資訊觀測站</a>
                            </div>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
};
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<ErrorBoundary><App /></ErrorBoundary>);
</script>
</body>
</html>
